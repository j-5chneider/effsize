---
title: "Reproducible_Documentation_of_Analysis_Study1"
format: html
editor: visual
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

## Import of the Data

The data was assessed with the `formr` survey framework [@arslan2020]. The raw data was imported via the following code.

```{r}
library(tidyverse)
library(hrbrthemes)
library(patchwork)
load("data/teachers_study1_N40.RData")
```

## Data Wrangling
```{r}
# wrangle information on the plot type, ES, ...
plot_info <- study1 %>%
    pivot_longer(2:195, names_to = "variables", values_to = "values", 
                 values_transform = as.character) %>%
    dplyr::filter(str_detect(variables, "plot")) %>% 
    # we only need the rows with info on plots
    tidyr::separate(col = values, into = c("type", "axis", "effsize"), 
                    # separate the info into three columns
                    sep = "_", remove = F) %>%
    dplyr::mutate(plot = variables,       # rename variables for later join
                  type = paste(type, axis, sep = "_")) %>%
    dplyr::select(-variables, -axis)

# wrangle answers to items on each page
item_values <- study1 %>%
    dplyr::select(-c(topic:itemo)) %>%
    pivot_longer(2:169, names_to = "variables", values_to = "values", 
                 values_transform = as.character) %>%
    dplyr::mutate(variables = case_when(      # recode variable names that have
        variables == "sensi_6" ~ "sensi_06",  # accidentally been labeled
        variables == "acccl_6" ~ "acccl_06",  # without zero
        variables == "accu3_6" ~ "accu3_06",
        variables == "accov_6" ~ "accov_06",
        variables == "diffi_6" ~ "diffi_06",
        variables == "infor_6" ~ "infor_06",
        variables == "value_6" ~ "value_06",
        TRUE ~ variables 
    )) %>%
    dplyr::mutate(plot = paste0("plotx_", str_sub(variables, -2, -1)), 
                  # create variable for later join
                  variables = str_sub(variables, 1, -4)) %>%    
    # rename variable names to get a data set 
    # with one line per participant per page
    pivot_wider(id_cols = c(session, plot), names_from = "variables", 
                values_from = "values")


# join the two data sets
study1_w <- full_join(plot_info, item_values, 
                               by = c("session", "plot")) %>% 
    # by participant and page (plot)
    dplyr::select(-values) %>%
    dplyr::mutate(acccl = as.numeric(acccl), # some var need to be defined as
                  accu3 = as.numeric(accu3), # numeric again
                  accov = as.numeric(accov),
                  diffi = as.numeric(diffi),
                  infor = as.numeric(infor),
                  value = as.numeric(value),
                  effsize = as.numeric(effsize),
                  effsize_cl = case_when( 
                  # there is no negative Cliff's Delta, so we have to compute 
                  # two transformations
                      effsize > 0 ~   (((2*pnorm(effsize/2))-1)/pnorm(effsize/2)),
                  # transform the actual effect size Cohen's d to Cliff's Delta
                      effsize < 0 ~ (- (((2*pnorm(abs(effsize)/2))-1)/pnorm(abs(effsize)/2))) 
                  # transform the actual effect size Cohen's d to Cliff's Delta 
                  # and make it negative as in the item
                  ),
                  effsize_u3 = pnorm(effsize), 
                  # transform the actual effect size Cohen's d to Cohen's U3
                  effsize_ov = 2 * pnorm(-abs(effsize) / 2), 
                  # transform the actual effect size Cohen's d to overlap
                  acccl_eff = (acccl - effsize_cl)/2, 
                  # actual accuracy of rating relative to depicted effectsize 
                  accu3_eff = (accu3/100) - effsize_u3, 
                  # actual accuracy of rating relative to depicted effectsize
                  accov_eff = (accov/100) - effsize_ov, 
                  # actual accuracy of rating relative to depicted effectsize 
                  diffi_normed = ((diffi - 1)  / 3) - 1, # transform item to -1 to 1
                  infor_normed = ((infor - 1)  / 3) - 1, # transform item to -1 to 1
                  value_normed = ((value - 1)  / 3) - 1) %>%  # transform item to -1 to 1
    group_by(session) %>% 
    mutate(# within-person rank transformation
           accov_wp_rank = rank(accov),
           accu3_wp_rank = rank(accu3),
           # within-person standardization
           accov_wp_stand = (accov - mean(accov, na.rm = T))/
               sd(accov, na.rm = T),
           accu3_wp_stand = (accu3 - mean(accu3, na.rm = T))/
               sd(accu3, na.rm = T),
           accov_missconcept = median(accov, na.rm = T) < 50,
           accu3_missconcept = median(accu3, na.rm = T) < 20) %>% 
    ungroup()
```

## Graphical Overview
### Accuracy
#### Distribution of the Variables
```{r}
study1_w %>% 
    select(acccl, accu3, accov, effsize) %>% 
    pivot_longer(
        c(acccl, accu3, accov),
        names_to = "operationalization", 
        values_to = "judged_effectsize"
        ) %>% 
    ggplot(., aes(judged_effectsize)) +
    geom_histogram() +
    facet_wrap(~operationalization, scales = "free_x")
```
Somewhat disturbing is the first mode in `accov`. Maybe some users confused `overlap` and `non-overlap`?
Another artefact seems to be the first mode in `accu3`.

#### Association of Ratings and Actual Effect Size
```{r}
study1_w %>% 
    ggplot(., aes(effsize, acccl)) +
    geom_jitter() +
    stat_smooth()

study1_w %>% 
    ggplot(., aes(effsize, accu3, color = accu3_missconcept)) +
    geom_jitter() +
    stat_smooth()

study1_w %>% 
    ggplot(., aes(abs(effsize), accov, color = accov_missconcept)) +
    geom_jitter() +
    stat_smooth(method = "lm")
```

The correlations undermine the interpretation of the missconceptions Therefor we will look at the intercorrelations of the dependent variables.

#### Compute Kendall's $\tau$ for `accl`, `accu3` and `accov`
```{r}
study1_w %>% 
    do(tau_cl = unlist(cor(.$effsize, .$acccl, method = "kendall", use = "pairwise.complete"))) %>% 
    unnest(tau_cl)

study1_w %>% 
    group_by(accov_missconcept) %>% 
    do(tau_ov = unlist(cor(abs(.$effsize), .$accov, method = "kendall", use = "pairwise.complete"))) %>% 
    unnest(tau_ov)

study1_w %>% 
    group_by(accu3_missconcept) %>% 
    do(tau_u3 = unlist(cor(abs(.$effsize), .$accu3, method = "kendall", use = "pairwise.complete"))) %>% 
    unnest(tau_u3)

```


#### Associations of the Dependent Variables
```{r}
ggplot(study1_w, 
       aes(acccl, accu3)) +
    geom_jitter() +
ggplot(study1_w, 
       aes(acccl, accov)) +
    geom_jitter() +
ggplot(study1_w, 
       aes(accov, accu3)) +
    geom_jitter()
```

#### Are there Constant Misconceptions per Persons?
```{r}
ggplot(study1_w %>% 
    select(acccl, accu3, accov, effsize, effsize_cl, session) %>% 
    pivot_longer(
        c(acccl, accu3, accov),
        names_to = "operationalization", 
        values_to = "judged_effectsize"
        ),
    aes(judged_effectsize, as.numeric(as.factor(session)),
        color = session)
        ) +
    geom_jitter(height = 0) +
    facet_wrap(~ operationalization, scales = "free_x") +
    theme(legend.position = "none")
```

It seems to be so, as ....
However, let's look at the rank transformation

```{r}
ggplot(study1_w %>% 
    select(acccl, accu3_wp_rank, accov_wp_rank,  session) %>% 
    pivot_longer(
        c(acccl, accu3_wp_rank, accov_wp_rank),
        names_to = "operationalization", 
        values_to = "judged_effectsize"
        ),
    aes(judged_effectsize, as.numeric(as.factor(session)),
        color = session)
        ) +
    geom_jitter(height = 0) +
    facet_wrap(~ operationalization, scales = "free_x") +
    theme(legend.position = "none")

cor(study1_w$effsize, study1_w$accu3_wp_rank, method = "kendall", use = "pairwise.complete")
```

